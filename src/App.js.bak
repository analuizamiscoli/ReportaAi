// Importa as bibliotecas principais do React e de roteamento.
import React, { useState } from 'react';
import { BrowserRouter as Router, Route, Routes } from 'react-router-dom';

// Importa todas as páginas que criamos.
import LandingPage from './pages/LandingPage';
import LoginPage from './pages/LoginPage';
import SignupPage from './pages/SignupPage';
import MapPage from './pages/MapPage';
import UserDashboard from './pages/UserDashboard';
import AdminDashboard from './pages/AdminDashboard';

// Importa as imagens locais para serem usadas nos dados de exemplo.
import buracoImg from './assets/buraco.jpg';
import lampadaImg from './assets/lampada.jpg';
import matoaltoImg from './assets/matoalto.jpg';
import lixoImg from './assets/lixo.jpg';

// --- FONTE DE DADOS PRINCIPAL ---
// Este array contém os dados iniciais de exemplo para as ocorrências.
// Em uma aplicação real, isso viria de um banco de dados.
const initialOccurrences = [
    { id: 1, pos: [-21.76, -43.35], status: 'reported', category: 'Buraco na Via', photo: buracoImg, supporters: 5, date: '2025-10-01', description: 'Buraco grande na via, perigoso para carros e motos.', userName: 'Ana Silva', userCpf: '123.456.789-00' },
    { id: 2, pos: [-21.77, -43.36], status: 'in-progress', category: 'Lâmpada Queimada', photo: lampadaImg, supporters: 12, date: '2025-09-28', description: 'Poste de luz com lâmpada queimada há uma semana.', userName: 'João Costa', userCpf: '987.654.321-00' },
    { id: 3, pos: [-21.75, -43.34], status: 'resolved', category: 'Mato Alto', photo: matoaltoImg, supporters: 20, date: '2025-09-15', description: 'Mato muito alto na praça, impedindo o uso.', userName: 'Maria Oliveira', userCpf: '111.222.333-44' },
    { id: 4, pos: [-21.755, -43.345], status: 'reported', category: 'Lixo Acumulado', photo: lixoImg, supporters: 2, date: '2025-10-02', description: 'Acúmulo de lixo na calçada.', userName: 'Pedro Martins', userCpf: '444.555.666-77' },
];

// O componente App é o componente principal que envolve toda a aplicação.
function App() {
  // --- GERENCIAMENTO DE ESTADO CENTRAL ---
  // `useState` é um "Hook" do React que permite adicionar um estado a um componente.
  // Aqui, estamos criando um estado chamado `occurrences` para armazenar a lista de todas as ocorrências.
  // `setOccurrences` é a função que usamos para atualizar essa lista.
  // Começamos o estado com os dados de exemplo de `initialOccurrences`.
  const [occurrences, setOccurrences] = useState(initialOccurrences);

  // --- FUNÇÕES DE MANIPULAÇÃO DE DADOS ---

  // Esta função é responsável por adicionar uma nova ocorrência à lista.
  // Ela será chamada pelo formulário quando o usuário clicar em "Enviar Ocorrência".
  const handleNewOccurrence = (newOcc) => {
    // Cria um ID único para a nova ocorrência.
    const newId = occurrences.length > 0 ? Math.max(...occurrences.map(o => o.id)) + 1 : 1;
    
    // Monta o objeto completo da nova ocorrência com os dados recebidos do formulário.
    const occurrenceToAdd = {
        id: newId,
        category: newOcc.category,
        pos: newOcc.pos,
        description: newOcc.description,
        photo: newOcc.photo ? newOcc.photo.previewUrl : null, // Garante que a URL da foto seja usada
        status: 'reported', // Toda nova ocorrência começa como "reportada".
        supporters: 1, // Começa com 1 apoio (o do próprio usuário).
        date: new Date().toISOString().split('T')[0], // Usa a data atual.
        // Dados de exemplo para o usuário que reportou.
        userName: 'Usuário Atual',
        userCpf: '123.123.123-12'
    };

    // Atualiza o estado, adicionando a nova ocorrência no início da lista.
    setOccurrences(prev => [occurrenceToAdd, ...prev]);
  };

  // Esta função é chamada pelo painel do administrador para mudar o status de uma ocorrência.
  const handleStatusChange = (id, newStatus) => {
    setOccurrences(currentOccurrences =>
      currentOccurrences.map(occ =>
        // Encontra a ocorrência pelo ID e atualiza apenas o seu status.
        occ.id === id ? { ...occ, status: newStatus } : occ
      )
    );
  };

  // --- ROTEAMENTO DA APLICAÇÃO ---
  // O `Router` gerencia a navegação entre as diferentes telas (páginas).
  // Cada `Route` define um caminho (URL) e qual componente de página deve ser exibido.
  return (
    <Router>
      <Routes>
        {/* Rota para a página inicial */}
        <Route path="/" element={<LandingPage />} />
        
        {/* Rotas para login e cadastro */}
        <Route path="/login" element={<LoginPage />} />
        <Route path="/signup" element={<SignupPage />} />
        
        {/* Rota para a página do mapa. Passamos a lista de ocorrências e as funções para ela. */}
        <Route 
            path="/mapa" 
            element={<MapPage 
                occurrences={occurrences} 
                setOccurrences={setOccurrences} 
                onNewOccurrence={handleNewOccurrence} 
            />}
        />
        
        {/* Rota para o perfil do usuário. Passamos a lista de ocorrências. */}
        <Route path="/perfil" element={<UserDashboard allOccurrences={occurrences} />} />
        
        {/* Rota para o painel do administrador. Passamos a lista e a função de mudar status. */}
        <Route 
            path="/admin" 
            element={<AdminDashboard 
                allOccurrences={occurrences} 
                onStatusChange={handleStatusChange} 
            />}
        />
      </Routes>
    </Router>
  );
}

export default App;
